name: Send Email with Swaks

on:
  workflow_dispatch:

jobs:
  send-email:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository (optional, if you need access to the repo's files)
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Install swaks
      - name: Install swaks
        run: sudo apt-get update && sudo apt-get install -y swaks

      # 3. Send email using swaks and capture the output
      - name: Send email
        id: send_email
        env:
          EMAIL_ADDRESS: ${{ secrets.EMAIL_ADDRESS }}
          EMAIL_TO: xielk@yeah.net
          EMAIL_SUBJECT: Cloudflare Traffic Report for the Last 30 Days
          EMAIL_BODY: |
            Hi,

            Here is the Cloudflare traffic report for the zone ID a768a88b8f71866844da6c81b533ba9c for the last 30 days:

            - Total Bandwidth: ${{ env.BANDWIDTH_TB }} TB
            - Total Requests: ${{ env.REQUESTS }}

            Best regards,
            Cloudflare Monitoring
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        run: |
          OUTPUT=$(swaks --to "$EMAIL_TO" \
                         --from "$EMAIL_ADDRESS" \
                         --server smtp.office365.com \
                         --port 587 \
                         --auth LOGIN \
                         --auth-user "$EMAIL_ADDRESS" \
                         --auth-password "$EMAIL_PASSWORD" \
                         --tls \
                         --header "Subject: $EMAIL_SUBJECT" \
                         --body "$EMAIL_BODY")
          echo "Email sent successfully. Output:"
          echo "$OUTPUT"
